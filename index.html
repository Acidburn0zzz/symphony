<!DOCTYPE html>
<html lang="en">
<head>
	<title>IOHK Implementation Example</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous"> -->
	<style>
		* {
			padding: 0;
			margin: 0;
		}

		html {
			width: 100%;
			height: 100vh;
			background: #000000;
			overflow: hidden;
		}

		body {
			margin: 0;
			padding: 0;
			font-size: 14px;
			font-family: Inconsolata;
			color: #b6bcbe;
			line-height: 1.3rem;
			overflow: hidden;
		}

		hr {
			display: block;
			height: 1px;
			border: 0;
			border-top: 1px solid #b6bcbe;
			margin: 1em 0;
			padding: 0;
		}

		a {
			color: #cccccc;
		}

		#hud{
			position: absolute;
			padding: 20px;	
		}

		canvas {
			width: 100%!important;
			height: 100%!important;
		}
	</style>
</head>

<body>
	<div id='hud'></div>
	<button id="mute" style="position: absolute; z-index: 9999">Mute</button>
	<button id="unmute" style="position: absolute; z-index: 9999; left: 50px">Un-mute</button>
	<div class="canvas-container">
		<canvas id="stage"></canvas>
	</div>
	<!-- <script src="app.js"></script> -->
	<script src="//unpkg.com/react@16/umd/react.development.js"></script>
	<script src="//unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
	<script src="//unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
	<script src="//unpkg.com/startaudiocontext@1.2.1/StartAudioContext.js"></script>
	<script type="text/babel">

		window.onload = function(){

			// check that browser supports webgl
			if ( !orpheusApp.canRun ) console.error('Orpheus cannot run :(')
				
			// Create the Orpeus App
			orpheusApp({ path: './static/assets/' }).then( app => {
				console.log('App returned from promise', app)
				window.app = app

				/**
				 * Setup Window resize listeners
				 */
				window.addEventListener('resize', () => app.setSize(window.innerWidth, window.innerHeight))
				app.setSize(window.innerWidth, window.innerHeight)
				
				/*
					Utility methods for navigating along the block chain
				*/
				const goToNextBlock = app.goToBlock
				const goToPrevBlock = app.goToBlock
				window.goToNextBlock = goToNextBlock
				window.goToPrevBlock = goToPrevBlock

				// Method to navigation to a new date in the blockchain
				// app.setDate(new Date(2018, 0, 1)) 

				/*
					Destroys the Orpheus instance and unloads all data.
					The application instance cannot be used after this is called
				*/
				// app.destroy()


				/*
					Event called when the first day loads
				*/
				app.on('firstDayLoaded', data => console.log('first day of blocks loaded'))

				/**
				 * on iOS devices, the user must first interact with the page before any sound will play
				 */
				app.audio.on('bgAudioLoaded', function () {
					StartAudioContext(app.audio.context, '#stage')

					var muteButton = document.querySelector('#mute')
					if (muteButton) {
						muteButton.addEventListener('click', function () {
							app.audio.muteAudio()
						})
					}

					var unMuteButton = document.querySelector('#unmute')
					if (unMuteButton) {
						unMuteButton.addEventListener('click', function () {
							app.audio.unMuteAudio()
						})
					}

				})

				/*
					Event called as a user scrolls through time and the current day changes
				*/
				app.on('dayChanged', ({ date, input, output, fee }) => {
					console.log('EVENT: `dayChanged` receieved')
					ReactDOM.render(		
						<div>	
							<h1>Day View</h1>
							<br/>
							<div>Date: { date.toString() }</div>
							<div>Fee: BTC{ fee.toLocaleString('USD') }</div>
							<div>Total Input Value: BTC{ input.toLocaleString('USD') }</div>
							<div>Total Output Value: BTC{ output.toLocaleString('USD') }</div>
						</div>
					,document.querySelector('#hud'))
				})

				/*
					Event called when a block is hovered over
				*/
				// app.on('blockHovered', console.log )


				/*
					Event called when a block is selected
				*/
				app.on('blockSelected', block => {

					const { bits, fee, feeToInputRatio, hash, height, input, n_tx, output, size, time } = block

					ReactDOM.render(		
						<div>	
							<h1>Block View</h1>
							<br/>
							<div>Date: { time.toString() }</div>
							<div>Bits: { bits.toLocaleString('USD') }</div>
							<div>Fee: BTC{ fee.toLocaleString('USD') }</div>
							<div>Fee Level: { feeToInputRatio }</div>
							<div>Block Hash: { hash.substr(-16) }</div>
							<div>Total Input Value: BTC{ input.toLocaleString('USD') }</div>
							<div>Total Output Value: BTC{ output.toLocaleString('USD') }</div>
							<div >Number of Transactions: { n_tx }</div>				
						</div>
					,document.querySelector('#hud'))
				})

				/*
					Event for whenever a block is unselected
				*/
				app.on('blockUnselected', _ => console.log('BLOCK UNSELECTED'))

				

				// move camera on z axis with mouse wheel
				const onDocumentMouseWheel = function (event) {
					if (app.scrollBlocked) {
						return
					}

					if (app.currentBlockObject) return

					event.preventDefault()

					if (Math.abs(event.deltaY) > 0) {
						app.scrollBlocked = true
						setTimeout(() => {
							app.scrollBlocked = false
						}, 50)
					}


					// const dayObj3Ds = app.dayObj3Ds.children
					// const maxCameraZPos = dayObj3Ds[dayObj3Ds.length - 1].position.z +  + app.stage.defaultCameraPos.z
    			// const minCameraZPos = dayObj3Ds[0].position.z + 1000.0

					if (event.deltaY > 0) {
						app.stage.targetCameraPos.z -= app.stage.cameraMoveStep
					} else if (event.deltaY < 0) {
						app.stage.targetCameraPos.z += app.stage.cameraMoveStep
					}

					app.stage.targetCameraLookAt.z = app.stage.targetCameraPos.z - 1000

				}

				document.addEventListener("wheel", onDocumentMouseWheel, false);
				document.addEventListener("mousewheel", onDocumentMouseWheel, false);
				// document.addEventListener("touchmove", onDocumentMouseWheel, false);
				window.onscroll = onDocumentMouseWheelz

			}).catch(e => console.log(e))

		}

	</script>

</body>

</html>
